<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>Testing Kepler</title>
    <script src='/devs/workspace/packages/dataframe/dist/@youwol/dataframe.js'></script>
    <script src='/devs/workspace/packages/math/dist/@youwol/math.js'></script>
    <script src='/devs/workspace/packages/geometry/dist/@youwol/geometry.js'></script>
    <script src='/devs/workspace/packages/io/dist/@youwol/io.js'></script>
    <script src='/devs/workspace/packages/three-extra/node_modules/three/build/three.min.js'></script>
    <script src='/devs/workspace/packages/three-extra/node_modules/three/examples/js/controls/TrackballControls.js'></script>
    <script src='/devs/workspace/packages/three-extra/node_modules/three/examples/js/renderers/SVGRenderer.js'></script>
    <script src='/devs/workspace/packages/three-extra/node_modules/three/examples/js/renderers/Projector.js'></script>
    <script src='/devs/workspace/packages/three-extra/dist/@youwol/three-extra.js'></script>
    <script src='/devs/workspace/packages/kepler/dist/@youwol/kepler.js'></script>
    <script src="https://kit.fontawesome.com/daa834e337.js" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/d3@5.7.0/dist/d3.min.js"></script>
    <script src="https://unpkg.com/d3fc@14.0.27/build/d3fc.js"></script>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
        integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <link rel="stylesheet" href="js/style.css">
</head>

<body>
    <div class="loading" id="js-loader">
        <div class="loader"></div>
    </div>
    <div class='home-container'>
        <span>
            <div class='buttonIcon' style="position: absolute; right: 80px;">
                <div id='goHome'><i class='fa fa-home'></i></div>
            </div>
            <div class='buttonIcon' style="position: absolute; right: 45px;">
                <div id='saveHome'><i class='fa fa-clinic-medical'></i></div>
            </div>
            <div class='right-container'>
                <div id='orientCubeWrapper'></div>
            </div>
        </span>
    </div>

    <input id="btnSVGExport" type="button" value="Export SVG" onclick="btnSVGExport()" style="position: absolute; opacity: 40%; margin-bottom:3px">

    <!-- <div class="top-1 start-1" style='position: absolute; opacity: 75%; left: 10px; top: 10px'>
        <div class="card" style="width: 300px; height: 150px; background-color: rgb(193, 193, 193);">
            <div class="card-body">
                <div class="card-title" style='font-size: 20px; font-weight: bold;'>Object info</div>
                <div class="card-text">Vertices:</div>
                <div class="card-text">Faces:</div>
                <div class="card-text">Center:</div>
            </div>
        </div>
    </div>

    <div class="top-1 start-1" style='position: absolute; opacity: 75%; left: 10px; top: 180px'>
        <div class="card" style="width: 300px; height: 130px; background-color: rgb(193, 193, 193);">
            <div class="card-body">
                <div class="card-title" style='font-size: 20px; font-weight: bold;'>Vertex info</div>
                <div class="card-text">Position:</div>
                <div class="card-text">attributes:</div>
            </div>
        </div>
    </div> -->

    <script type="text/javascript" src='./js/doSurfaces.js'></script>
    <script type="text/javascript" src='./js/doLines.js'></script>
    <script type="text/javascript" src='./js/doPointset.js'></script>
    <script type="text/javascript" src='./js/postInit.js'></script>
    <script type="text/javascript" src='./js/utils.js'></script>
    <script type="text/javascript" src='./js/init.js'></script>

    <script>
        // Copyright 2021, Observable Inc.
        // Released under the ISC license.
        // https://observablehq.com/@d3/color-legend
        /*
        function Legend(color, {
            title,
            tickSize = 6,
            width = 320,
            height = 44 + tickSize,
            marginTop = 18,
            marginRight = 0,
            marginBottom = 16 + tickSize,
            marginLeft = 0,
            ticks = width / 64,
            tickFormat,
            tickValues
        } = {}) {

            function ramp(color, n = 256) {
                const canvas = document.createElement("canvas");
                canvas.width = n;
                canvas.height = 1;
                const context = canvas.getContext("2d");
                for (let i = 0; i < n; ++i) {
                    context.fillStyle = color(i / (n - 1));
                    context.fillRect(i, 0, 1, 1);
                }
                return canvas;
            }

            const svg = d3.create("svg")
                .attr("width", width)
                .attr("height", height)
                .attr("viewBox", [0, 0, width, height])
                .style("overflow", "visible")
                .style("display", "block");

            let tickAdjust = g => g.selectAll(".tick line").attr("y1", marginTop + marginBottom - height);
            let x;

            // Continuous
            if (color.interpolate) {
                const n = Math.min(color.domain().length, color.range().length);

                x = color.copy().rangeRound(d3.quantize(d3.interpolate(marginLeft, width - marginRight), n));

                svg.append("image")
                    .attr("x", marginLeft)
                    .attr("y", marginTop)
                    .attr("width", width - marginLeft - marginRight)
                    .attr("height", height - marginTop - marginBottom)
                    .attr("preserveAspectRatio", "none")
                    .attr("xlink:href", ramp(color.copy().domain(d3.quantize(d3.interpolate(0, 1), n))).toDataURL());
            }

            // Sequential
            else if (color.interpolator) {
                x = Object.assign(color.copy()
                    .interpolator(d3.interpolateRound(marginLeft, width - marginRight)),
                    { range() { return [marginLeft, width - marginRight]; } });

                svg.append("image")
                    .attr("x", marginLeft)
                    .attr("y", marginTop)
                    .attr("width", width - marginLeft - marginRight)
                    .attr("height", height - marginTop - marginBottom)
                    .attr("preserveAspectRatio", "none")
                    .attr("xlink:href", ramp(color.interpolator()).toDataURL());

                // scaleSequentialQuantile doesnâ€™t implement ticks or tickFormat.
                if (!x.ticks) {
                    if (tickValues === undefined) {
                        const n = Math.round(ticks + 1);
                        tickValues = d3.range(n).map(i => d3.quantile(color.domain(), i / (n - 1)));
                    }
                    if (typeof tickFormat !== "function") {
                        tickFormat = d3.format(tickFormat === undefined ? ",f" : tickFormat);
                    }
                }
            }

            // Threshold
            else if (color.invertExtent) {
                const thresholds
                    = color.thresholds ? color.thresholds() // scaleQuantize
                        : color.quantiles ? color.quantiles() // scaleQuantile
                            : color.domain(); // scaleThreshold

                const thresholdFormat
                    = tickFormat === undefined ? d => d
                        : typeof tickFormat === "string" ? d3.format(tickFormat)
                            : tickFormat;

                x = d3.scaleLinear()
                    .domain([-1, color.range().length - 1])
                    .rangeRound([marginLeft, width - marginRight]);

                svg.append("g")
                    .selectAll("rect")
                    .data(color.range())
                    .join("rect")
                    .attr("x", (d, i) => x(i - 1))
                    .attr("y", marginTop)
                    .attr("width", (d, i) => x(i) - x(i - 1))
                    .attr("height", height - marginTop - marginBottom)
                    .attr("fill", d => d);

                tickValues = d3.range(thresholds.length);
                tickFormat = i => thresholdFormat(thresholds[i], i);
            }

            // Ordinal
            else {
                x = d3.scaleBand()
                    .domain(color.domain())
                    .rangeRound([marginLeft, width - marginRight]);

                svg.append("g")
                    .selectAll("rect")
                    .data(color.domain())
                    .join("rect")
                    .attr("x", x)
                    .attr("y", marginTop)
                    .attr("width", Math.max(0, x.bandwidth() - 1))
                    .attr("height", height - marginTop - marginBottom)
                    .attr("fill", color);

                tickAdjust = () => { };
            }

            svg.append("g")
                .attr("transform", `translate(0,${height - marginBottom})`)
                .call(d3.axisBottom(x)
                    .ticks(ticks, typeof tickFormat === "string" ? tickFormat : undefined)
                    .tickFormat(typeof tickFormat === "function" ? tickFormat : undefined)
                    .tickSize(tickSize)
                    .tickValues(tickValues))
                .call(tickAdjust)
                .call(g => g.select(".domain").remove())
                .call(g => g.append("text")
                    .attr("x", marginLeft)
                    .attr("y", marginTop + marginBottom - height - 6)
                    .attr("fill", "currentColor")
                    .attr("text-anchor", "start")
                    .attr("font-weight", "bold")
                    .attr("class", "title")
                    .text(title));

            return svg.node();
        }
        function legend({ color, ...options }) {
            return Legend(color, options);
        }*/
    </script>

    <script>
        const three = globalThis['THREE']
        const dataframe = globalThis['@youwol/dataframe']
        const math = globalThis['@youwol/math']
        const geom = globalThis['@youwol/geometry']
        const io = globalThis['@youwol/io']
        const extra = globalThis['@youwol/three-extra']
        const kepler = globalThis['@youwol/kepler']

        const model = {
            grid: false,
            bbox: false,
            backgroundColor: '#aaa',
            colorScale: false
        }

        const spacing = 0.1

        const surfaceset = [
            {
                // url: ["/devs/platform/components/arch-node/examples/tests/friction/result-grid-1.1.ts"],
                // url: '/data/mesh/bunny.ts',
                // url: '/data/mesh/bunny.off',
                // url: "/data/arch/spanish-peak/forward-grid.ts",
                // url: '/devs/platform/components/arch-node/examples/tests/HS/result-obs.gcd',
                url: [
                    '/devs/platform/components/arch-node/examples/tests/imposed-displ/HS/vert_grid_arch_all.ts'
                ],
                show: true,
                attr: 'Sxx',
                lut: 'Insar',
                duplicateLut: 1,
                surface: {
                    show: true,
                    color: '#aaa',
                    flat: false,
                    creaseAngle: 0,
                    opacity: 1
                },
                iso: {
                    show: false,
                    showFill: true,
                    showLines: true,
                    flat: false,
                    // spacing,
                    nb: 20,
                    // useMinMax: true,
                    // min: -10,
                    // max: 2,
                },
                streamlines: {
                    show: true,
                    attr: 'U',
                    color: '#000000'
                },
                vectors: {
                    show: false,
                    attr: 'S1',
                    scale: 0.05,
                    color: '#000000',
                    useTube: false,
                    radius: 20
                },
                band: {
                    show: false,
                    attr: 'z',
                    from: 100,
                    to  : 110,
                    color: '#000000',
                    scale: 0.1
                },
                wireframe: {
                    show: false,
                    color: '#000000'
                },
                borders: {
                    show: true,
                    color: "#000000"
                }
            },
            {
                // url: '/devs/platform/components/arch-node/examples/tests/HS/planar_fault.ts',
                url: '/devs/platform/components/arch-node/examples/tests/imposed-displ/HS/vert_grid_Poly3D_bbb.ts',
                show: false,
                attr: '',
                lut: 'Insar',
                duplicateLut: 1,
                translation: [0, 0, 0],
                surface: {
                    show: false,
                    color: '#aaa',
                    flat: true,
                    creaseAngle: 0,
                    opacity: 1
                },
                iso: {
                    show: true,
                    showFill: true,
                    showLines: true,
                    flat: false,
                    spacing,
                    // nb: 20,
                    // useMinMax: true,
                    // min: -3,
                    // max: 2,
                },
                wireframe: {
                    show: false,
                    color: '#000000'
                },
                borders: {
                    show: true,
                    color: "#000000"
                }
            }
        ]

        const plines = [
            {
                url: [ 
                    '/data/streamlines/test.pl'
                ],
                show: false,
                useTube: false,
                tubeRadius: 0.01,
                color: "#000"
            }
        ]
        const pointsets = []

        init()
        load()
        requestAnimationFrame(animate)

        // Legend(d3.scaleDiverging([-0.1, 0, 0.1], d3.interpolatePiYG), {
        //     title: "Daily change",
        //     tickFormat: "+%"
        // })

        // ========================================================
        //                ADD D3.js in the 3D view
        // See https://bl.ocks.org/Ro4052/caaf60c1e9afcd8ece95034ea91e1eaa
        // See https://github.com/ttdtrang/d3-colorbar
        // See https://observablehq.com/@d3/color-legend
        // See https://github.com/d3/d3-scale-chromatic
        //
        // See https://github.com/bmschmidt/colorbar
        // See https://d3-legend.susielu.com/
        // ========================================================

        
        // const container = d3.create("div")

        if (model.colorScale === true) {
            const container = d3.select("#chart")
            // const container = d3.select("body").append("div")
            // container //.attr("id", "chart")
            //     .style('position', 'absolute')
            //     .style('top', '150px')
            //     .style('right', '0px')
            //     .style('width', '100%')
            //     .style('z-index', '100')

            container
                .append("text")
                .attr("x", 100)
                .attr("y", 78)
                .text("Sxx");

            const colourScale = d3
                .scaleSequential(d3.interpolateViridis)
                // .scaleSequential(d3.interpolatePiYG)
                .domain([0, 22]);
            const domain = colourScale.domain();

            const width = 100;
            const height = 150;

            const paddedDomain = fc.extentLinear()
                .pad([0.1, 0.1])
                .padUnit("percent")(domain);
            const [min, max] = paddedDomain;
            const expandedDomain = d3.range(min, max, (max - min) / height);

            const xScale = d3
                .scaleBand()
                .domain([0, 1])
                .range([0, width]);

            const yScale = d3
                .scaleLinear()
                .domain(paddedDomain)
                .range([height, 0]);


            const svgBar = fc
                .autoBandwidth(fc.seriesSvgBar())
                .xScale(xScale)
                .yScale(yScale)
                .crossValue(0)
                .baseValue((_, i) => (i > 0 ? expandedDomain[i - 1] : 0))
                .mainValue(d => d)
                .decorate(selection => {
                    selection.selectAll("path").style("fill", d => colourScale(d));
                })

            const axisLabel = fc
                .axisRight(yScale)
                .tickValues([...domain, (domain[1] + domain[0]) / 2])
                .tickSizeOuter(0);

            const legendSvg = container.append("svg")
                .attr("height", height)
                .attr("width", width);

            const legendBar = legendSvg
                .append("g")
                .datum(expandedDomain)
                .call(svgBar);

            const barWidth = Math.abs(legendBar.node().getBoundingClientRect().x);
            legendSvg.append("g")
                // .attr("transform", `translate(${barWidth})`)
                .attr("transform", `translate(25)`)
                // .datum(expandedDomain)
                .call(axisLabel)
                .select(".domain")
                .attr("visibility", "hidden");

            container.style("margin", "1em");
            //container.append("text").attr("x", width).attr("y", 78).text("Min");
        }
        

    </script>
</body>

</html>